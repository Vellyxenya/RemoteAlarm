# Security Considerations

## Threat Model

### Assets
- Audio recordings (potentially private)
- MQTT broker credentials
- Firebase Storage bucket

### Threats
1. Unauthorized audio downloads
2. MQTT credential theft
3. Unauthorized uploads
4. Message interception
5. Replay attacks

## Security Measures

### 1. Private Storage Bucket
**Threat Mitigated**: Unauthorized audio downloads

Firebase Storage rules prevent direct downloads:
```js
allow read: if false;
```

Only signed URLs generated by Cloud Function allow downloads.

### 2. Short-Lived Signed URLs
**Threat Mitigated**: URL sharing/leaking

- URLs expire in 5 minutes
- Minimal window for unauthorized access
- No long-term URL validity

### 3. Anonymous Authentication
**Threat Mitigated**: Unauthorized uploads

- Only authenticated app users can upload
- Easy setup, no user management
- Can upgrade to Google Sign-In if needed

### 4. MQTT over TLS
**Threat Mitigated**: Message interception

- All MQTT traffic encrypted (port 8883)
- Prevents eavesdropping
- Broker certificate validation

### 5. MQTT Authentication
**Threat Mitigated**: Unauthorized broker access

- Username/password required
- Credentials stored securely on device
- Separate credentials per device possible

### 6. Topic ACL
**Threat Mitigated**: Cross-device message access

- Each device subscribes only to its topic
- Cloud Function publishes to specific device
- Prevents device-to-device interference

### 7. Optional HMAC Signing
**Threat Mitigated**: Message tampering, replay attacks

Future enhancement:
```javascript
// Cloud Function
const signature = crypto.createHmac('sha256', SECRET_KEY)
  .update(payload)
  .digest('hex');

// ESP32 verifies before downloading
```

## Best Practices

### Credential Management
- Never commit credentials to git
- Use environment variables or secrets manager
- Rotate credentials periodically
- Use separate credentials per environment (dev/prod)

### Storage
- Implement file retention policy (auto-delete old audio)
- Monitor storage usage
- Consider encrypting audio files at rest

### Monitoring
- Enable Firebase audit logs
- Monitor MQTT connection patterns
- Alert on unusual activity
- Track Cloud Function invocations

### Network
- Validate TLS certificates on ESP32
- Use certificate pinning if possible
- Keep ESP-IDF and libraries updated

## Limitations

Current security model assumes:
- Trusted mobile app user
- Single ESP32 device (or small number)
- Low-stakes audio content
- Serverless cost optimization

For production/multi-user scenarios, consider:
- User authentication (Google Sign-In, etc.)
- Per-user device registration
- Audio file encryption
- Enhanced HMAC with nonces
- Rate limiting
