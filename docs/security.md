# Security Considerations

## Threat Model

### Assets
- Audio recordings (potentially private)
- MQTT broker credentials
- WiFi credentials
- Firebase Storage bucket

### Threats
1. Unauthorized audio downloads
2. MQTT/WiFi credential theft
3. Unauthorized uploads
4. Message interception
5. Replay attacks

## Security Measures

### 1. Private Storage Bucket
**Threat Mitigated**: Unauthorized audio downloads

Firebase Storage rules prevent direct downloads:
```js
allow read: if false;
```
Only signed URLs generated by Cloud Function allow downloads.

### 2. Short-Lived Signed URLs
**Threat Mitigated**: URL sharing/leaking

- URLs expire in 5 minutes.
- Minimal window for unauthorized access.
- No long-term URL validity.

### 3. Anonymous Authentication
**Threat Mitigated**: Unauthorized uploads

- Only authenticated app users can upload.
- Prevents drive-by uploads to the bucket.

### 4. MQTT over TLS (MQTTS)
**Threat Mitigated**: Message interception

- All MQTT traffic is encrypted using TLS (port 8883).
- Prevents eavesdropping on notification payloads.
- Validates the broker certificates using the MBEDTLS bundle in the firmware.

### 5. MQTT Authentication & Topic ACL
**Threat Mitigated**: Unauthorized broker access

- Username/password required for all MQTT connections.
- HiveMQ Cloud ACLs ensure the Cloud Function can only publish, and the ESP32 can only subscribe.
- Topic isolation (e.g., `home/audio/device1`) prevents device-to-device interference.

## Credential Management

### Firmware (ESP32)
**Mitigation**: Standardized Kconfig system.
- **Method**: Credentials (WiFi SSID/Pass, MQTT User/Pass) are managed via `idf.py menuconfig`.
- **Storage**: Actual values are stored in a local `sdkconfig` file.
- **Git Safety**: `sdkconfig` and `sdkconfig.defaults` are explicitly ignored in `.gitignore`. **NEVER hardcode credentials in main.c.**
- **Configuration Template**: Use `sdkconfig.defaults.template` as a base. Copy it to `sdkconfig.defaults` and fill in your details locally.
    ```ini
    # Example format (see sdkconfig.defaults.template)
    CONFIG_EXAMPLE_WIFI_SSID="YOUR_SSID"
    CONFIG_EXAMPLE_WIFI_PASSWORD="YOUR_PASSWORD"
    # ... other credentials ...
    ```

### Backend (Cloud Functions)
**Mitigation**: Firebase Parameter Objects (`params`).
- **Method**: Uses the modern `defineString` and `defineInt` from `firebase-functions/params`.
- **Configuration**: Set via `.env` files or CLI prompts during deployment.
- **Git Safety**: `.env` and `.env.local` files are ignored in `.gitignore`.

### Mobile App (Flutter)
**Mitigation**: API Key Restriction.
- **Method**: Firebase API keys are restricted in the Google Cloud Console to only allow the specific Android/iOS package IDs.
- **Safety**: While `firebase_options.dart` is checked in, the keys within are restricted at the service level.

## Best Practices

### Storage Maintenance
- Implement a lifecycle policy in Firebase Storage to automatically delete audio files older than 24 hours.

### Monitoring
- Review Firebase audit logs for unusual upload patterns.
- Monitor HiveMQ connection logs for failed auth attempts.

### Network
- Periodically update the ESP-IDF certificate bundle to ensure TLS connections remain valid and secure.
