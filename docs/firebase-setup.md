# Phase 0: Firebase Setup Guide

This guide walks through setting up the Firebase backend for RemoteAlarm.

## Prerequisites

- Node.js and npm installed
- Firebase account ([console.firebase.google.com](https://console.firebase.google.com))
- Firebase CLI: `npm install -g firebase-tools`

## Step 1: Create Firebase Project

1. Go to [Firebase Console](https://console.firebase.google.com)
2. Click "Add project"
3. Enter project name: `remotealarm` (or your preferred name)
4. Disable Google Analytics (optional for MVP)
5. Click "Create project"
6. Wait for project creation to complete

## Step 2: Enable Required Services

### 2.1 Enable Firebase Storage

1. In Firebase Console, navigate to **Build**  **Storage**
2. Click "Get Started"
3. Start in **production mode** (we'll apply custom rules)
4. Choose a Cloud Storage location (select closest to your region)
5. Click "Done"

### 2.2 Enable Firebase Authentication

1. Navigate to **Build**  **Authentication**
2. Click "Get Started"
3. Go to **Sign-in method** tab
4. Enable **Anonymous** authentication:
   - Click on "Anonymous"
   - Toggle "Enable"
   - Click "Save"

### 2.3 Enable Firebase Cloud Functions

1. Navigate to **Build**  **Functions**
2. Click "Get Started"
3. Follow prompts to enable Cloud Functions API
4. Choose a region for your functions (same as Storage)

## Step 3: Configure Firebase CLI

### 3.1 Login to Firebase

```bash
firebase login
```

This will open a browser for authentication.

### 3.2 Link Local Project to Firebase

1. Copy `.firebaserc.template` to `.firebaserc`:
   ```bash
   cp .firebaserc.template .firebaserc
   ```

2. Edit `.firebaserc` and replace `your-project-id` with your actual Firebase project ID:
   ```json
   {
     "projects": {
       "default": "remotealarm-12345"
     }
   }
   ```

   You can find your project ID in Firebase Console  Project Settings.

## Step 4: Deploy Storage Security Rules

Deploy the storage rules defined in `storage.rules`:

```bash
firebase deploy --only storage
```

Verify the rules in Firebase Console  Storage  Rules.

### What These Rules Do

- **Audio uploads**: Only authenticated users can upload to `/audio/*`
- **No direct reads**: Prevents direct file downloads
- **Signed URLs only**: Downloads only work via temporary signed URLs generated by Cloud Functions

## Step 5: Verify Setup

1. **Storage**: Firebase Console  Storage should show your bucket
2. **Authentication**: Authentication  Sign-in method should show Anonymous enabled
3. **Rules**: Storage  Rules should match `storage.rules`

## Next Steps

After completing Phase 0:
- Phase 1: Implement Flutter mobile app
- Phase 2: Implement Cloud Functions (see deployment notes below)
- Phase 3: Set up MQTT broker (HiveMQ Cloud)
- Phase 4: Implement ESP32 firmware

## Cloud Functions Configuration (Params)

### Setting Parameters with .env

For local testing with Firebase Emulators:

1. Copy `.env.example` to `.env` in the `functions/` directory
2. Update the values with your actual credentials
3. Run emulators: `firebase emulators:start`

The `.env` file is gitignored and won't be committed.

### Updating Parameters

To update a parameter after deployment:

```bash
firebase functions:secrets:set MQTT_PASSWORD
# Or for non-secret params
firebase deploy --only functions --set-params MQTT_USERNAME="new-username"
```

## Troubleshooting

### Firebase CLI not found
```bash
npm install -g firebase-tools
```

### Permission denied during deploy
Make sure you're logged in:
```bash
firebase login --reauth
```

### Wrong project selected
Check `.firebaserc` has the correct project ID, or use:
```bash
firebase use <project-id>
```

## Security Notes

- `.firebaserc` contains your project ID (safe to commit)
- Never commit service account keys or secrets
- Storage rules prevent unauthorized access
- Anonymous auth is sufficient for MVP; upgrade to Google Sign-In for production
